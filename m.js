
const css = atob("KnttYXJnaW46MDtwYWRkaW5nOjA7Ym94LXNpemluZzpib3JkZXItYm94fWh0bWwsYm9keXtoZWlnaHQ6MTAwJTt3aWR0aDoxMDAlO2ZvbnQtZmFtaWx5OidTZWdvZSBVSScsc2Fucy1zZXJpZjtiYWNrZ3JvdW5kOiMxMjEyMTI7Y29sb3I6I2ZmZn1ib2R5e2Rpc3BsYXk6ZmxleDtmbGV4LWRpcmVjdGlvbjpjb2x1bW59Lm5hdmJhcnt3aWR0aDoxMDAlO2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjthbGlnbi1pdGVtczpjZW50ZXI7YmFja2dyb3VuZDojMTgxODE4O3BhZGRpbmc6MXJlbSAycmVtO2JvcmRlci1ib3R0b206MXB4IHNvbGlkICMzMzM7cG9zaXRpb246c3RpY2t5O3RvcDowO3otaW5kZXg6MTAwMH0ubmF2YmFyIC5sb2dve2ZvbnQtc2l6ZToxLjVyZW07Zm9udC13ZWlnaHQ6Ym9sZDtjb2xvcjojZmYwMDUwO3RleHQtZGVjb3JhdGlvbjpub25lfS5uYXZiYXIgbmF2IGF7Y29sb3I6I2NjYzt0ZXh0LWRlY29yYXRpb246bm9uZTttYXJnaW4tbGVmdDoxLjVyZW07Zm9udC13ZWlnaHQ6NTAwO3RyYW5zaXRpb246Y29sb3IgLjNzIGVhc2V9Lm5hdmJhciBuYXYgYTpob3Zlcntjb2xvcjojZmYwMDUwfS5tYWlue2ZsZXg6MTtwYWRkaW5nOjNyZW0gMXJlbTt0ZXh0LWFsaWduOmNlbnRlcjt3aWR0aDoxMDAlO21heC13aWR0aDoxMDB2d30ubWFpbiBoMXtmb250LXNpemU6Mi41cmVtO21hcmdpbi1ib3R0b206MXJlbX0ubWFpbiBwe2NvbG9yOiNiYmI7bWFyZ2luLWJvdHRvbToycmVtfS5pbnB1dC1ncm91cHtkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OmNlbnRlcjtmbGV4LXdyYXA6d3JhcDttYXgtd2lkdGg6MTAwJTtnYXA6LjVyZW07cGFkZGluZzowIDFyZW19LmlucHV0LWdyb3VwIGlucHV0e2ZsZXg6MTttaW4td2lkdGg6MzAwcHg7bWF4LXdpZHRoOjYwMHB4O3BhZGRpbmc6MXJlbTtib3JkZXI6bm9uZTtib3JkZXItcmFkaXVzOjhweDtmb250LXNpemU6MXJlbTtiYWNrZ3JvdW5kOiMyYTJhMmE7Y29sb3I6I2ZmZn0uaW5wdXQtZ3JvdXAgYnV0dG9ue2JhY2tncm91bmQ6I2ZmMDA1MDtib3JkZXI6bm9uZTtwYWRkaW5nOjFyZW0gMS41cmVtO2NvbG9yOiNmZmY7Zm9udC13ZWlnaHQ6Ym9sZDtib3JkZXItcmFkaXVzOjhweDtjdXJzb3I6cG9pbnRlcjt0cmFuc2l0aW9uOmJhY2tncm91bmQgLjNzIGVhc2V9LmlucHV0LWdyb3VwIGJ1dHRvbjpkaXNhYmxlZHtiYWNrZ3JvdW5kOiM1NTU7Y3Vyc29yOm5vdC1hbGxvd2VkfS5oaW50e2NvbG9yOiM4ODg7Zm9udC1zaXplOi45cmVtO21hcmdpbi10b3A6LjVyZW07bWFyZ2luLWJvdHRvbToycmVtfS50dXJuc3RpbGUtYm94e2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO21hcmdpbjoxcmVtIDAgMnJlbX0jb3V0cHV0e2Rpc3BsYXk6bm9uZTttYXJnaW4tdG9wOjJyZW07YmFja2dyb3VuZDojMWUxZTFlO3BhZGRpbmc6MS41cmVtO2JvcmRlci1yYWRpdXM6MTBweDtib3gtc2hhZG93OjAgNHB4IDEycHggcmdiYSgwLDAsMCwuMyk7bWF4LXdpZHRoOjgwMHB4O21hcmdpbi1sZWZ0OmF1dG87bWFyZ2luLXJpZ2h0OmF1dG87dGV4dC1hbGlnbjpsZWZ0fS52aWRlby1yZXN1bHR7YmFja2dyb3VuZDojMWUxZTFlO3BhZGRpbmc6MS41cmVtO2JvcmRlci1yYWRpdXM6MTBweDtib3gtc2hhZG93OjAgNHB4IDEycHggcmdiYSgwLDAsMCwuMyk7bWFyZ2luLXRvcDoycmVtO3RleHQtYWxpZ246Y2VudGVyfS52aWRlby1oZWFkZXJ7Zm9udC1zaXplOjEuNXJlbTtjb2xvcjojZmYwMDUwO21hcmdpbi1ib3R0b206MXJlbTt0ZXh0LWFsaWduOmNlbnRlcn0udmlkZW8tcGxheWVye3dpZHRoOjEwMCU7bWF4LXdpZHRoOjEwMDBweDtoZWlnaHQ6YXV0bztib3JkZXItcmFkaXVzOjEycHg7bWFyZ2luOjAgYXV0byAxcmVtO2Rpc3BsYXk6YmxvY2t9LnZpZGVvLXRpdGxle2NvbG9yOiNjY2M7Zm9udC1zaXplOjFyZW07YmFja2dyb3VuZDojMmEyYTJhO3BhZGRpbmc6MXJlbTtib3JkZXItcmFkaXVzOjhweDttYXJnaW4tYm90dG9tOjFyZW07bWF4LWhlaWdodDoyMDBweDtvdmVyZmxvdzphdXRvO3doaXRlLXNwYWNlOnByZS13cmFwO3RleHQtYWxpZ246bGVmdH0uZG93bmxvYWQtYnV0dG9uc3tkaXNwbGF5OmZsZXg7ZmxleC13cmFwOndyYXA7anVzdGlmeS1jb250ZW50OmNlbnRlcjtnYXA6LjVyZW19LmRvd25sb2FkLWJ1dHRvbnMgc2VsZWN0LC5kb3dubG9hZC1idXR0b25zIGJ1dHRvbntiYWNrZ3JvdW5kOiNmZjAwNTA7Ym9yZGVyOm5vbmU7cGFkZGluZzouNzVyZW07Y29sb3I6I2ZmZjtmb250LXdlaWdodDpib2xkO2JvcmRlci1yYWRpdXM6OHB4O2N1cnNvcjpwb2ludGVyO3RyYW5zaXRpb246YmFja2dyb3VuZCAuM3MgZWFzZTtmb250LXNpemU6MXJlbTt3aWR0aDoxODBweDt0ZXh0LWFsaWduOmNlbnRlcn0uZG93bmxvYWQtYnV0dG9ucyBzZWxlY3Q6aG92ZXIsLmRvd25sb2FkLWJ1dHRvbnMgYnV0dG9uOmhvdmVye2JhY2tncm91bmQ6I2UwMDQ0NX0uZGF0YS1jb250YWluZXJ7YmFja2dyb3VuZDojMWUxZTFlO3BhZGRpbmc6MS41cmVtO2JvcmRlci1yYWRpdXM6MTBweDttYXJnaW4tdG9wOjFyZW07Y29sb3I6I2NjYzt0ZXh0LWFsaWduOmxlZnQ7Zm9udC1zaXplOi45cmVtfS5kYXRhLWNvbnRhaW5lciBwe21hcmdpbjouNXJlbSAwfWZvb3RlcntiYWNrZ3JvdW5kOiMxZTFlMWU7cGFkZGluZzoxLjVyZW07dGV4dC1hbGlnbjpjZW50ZXI7Y29sb3I6I2NjYzttYXJnaW4tdG9wOjJyZW07Ym9yZGVyLXRvcDoxcHggc29saWQgIzMzMztmb250LXNpemU6Ljk1cmVtfWZvb3RlciAuZm9vdGVyLWxpbmtze2Rpc3BsYXk6ZmxleDtmbGV4LXdyYXA6d3JhcDtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO2dhcDouNXJlbTttYXJnaW4tYm90dG9tOjFyZW19Zm9vdGVyIGF7Y29sb3I6I2ZmMDA1MDt0ZXh0LWRlY29yYXRpb246bm9uZTtmb250LXNpemU6MXJlbTt0cmFuc2l0aW9uOmNvbG9yIC4zcyBlYXNlO21hcmdpbjowIDRweH1mb290ZXIgYTpob3Zlcntjb2xvcjojZTAwNDQ1O3RleHQtZGVjb3JhdGlvbjp1bmRlcmxpbmV9Zm9vdGVyIHB7bWFyZ2luOjA7Zm9udC1zaXplOi45cmVtfUBtZWRpYShtYXgtd2lkdGg6NjAwcHgpey5pbnB1dC1ncm91cHtmbGV4LWRpcmVjdGlvbjpjb2x1bW47YWxpZ24taXRlbXM6c3RyZXRjaH0uaW5wdXQtZ3JvdXAgaW5wdXQsLmlucHV0LWdyb3VwIGJ1dHRvbnt3aWR0aDoxMDAlfS5kb3dubG9hZC1idXR0b25ze2ZsZXgtZGlyZWN0aW9uOmNvbHVtbjtnYXA6Ljc1cmVtfS5kb3dubG9hZC1idXR0b25zIHNlbGVjdCwuZG93bmxvYWQtYnV0dG9ucyBidXR0b257d2lkdGg6MTAwJX1mb290ZXIgLmZvb3Rlci1saW5rc3tmbGV4LWRpcmVjdGlvbjpjb2x1bW47Z2FwOi41cmVtfX0=");
const style = document.createElement("style");
style.innerHTML = css;
document.head.appendChild(style);

document.addEventListener("DOMContentLoaded", () => {
  const box = document.createElement("div");
  box.className = "box";
  document.body.appendChild(box);

  // Tambahkan elemen CAPTCHA
  const captchaContainer = document.createElement("div");
  captchaContainer.id = "captcha-box";
  captchaContainer.innerHTML = `<div class="cf-turnstile" data-sitekey="0x4AAAAAABit7LP-lm7dtuNk" data-callback="onTurnstileSuccess"></div>`;
  document.body.appendChild(captchaContainer);
});

let turnstileToken = "XxX";
const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";

function onTurnstileSuccess(token) {
  turnstileToken = token;
  document.getElementById("downloadBtn").disabled = false;
  const captchaBox = document.getElementById("captcha-box");
  if (captchaBox) captchaBox.style.display = "none";
}

window.addEventListener("load", () => {
  const captchaBox = document.getElementById("captcha-box");
  if (isLocalhost) {
    turnstileToken = "test-token";
    document.getElementById("downloadBtn").disabled = false;
    if (captchaBox) captchaBox.style.display = "none";
  } else {
    const script = document.createElement("script");
    script.src = "https://challenges.cloudflare.com/turnstile/v0/api.js";
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
    if (captchaBox) captchaBox.style.display = "block";
  }
});

async function download() {
  if (!turnstileToken) {
    alert("Please complete CAPTCHA verification first.");
    return;
  }

  const url = document.getElementById("url").value.trim();
  const output = document.getElementById("output");

  if (!/^https?:\/\/(www\.|vt\.)?tiktok\.com\/.+/.test(url)) {
    output.innerHTML = "⚠️ Invalid TikTok URL.";
    output.style.display = "block";
    return;
  }

  output.style.display = "block";
  output.innerHTML = "⏳ Processing...";

  const inputGroup = document.getElementById("input-group");
  const hint = document.getElementById("hint");
  const captchaBox = document.getElementById("captcha-box");

  if (inputGroup) inputGroup.style.display = "none";
  if (hint) hint.style.display = "none";
  if (captchaBox) captchaBox.style.display = "none";

  const form = new URLSearchParams({ url, hd: "1" });

  try {
    const res = await fetch("https://tikwm.com/api/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "User-Agent": "Mozilla/5.0",
        Referer: "https://tikwm.com/",
      },
      body: form
    });

    const data = await res.json();
    if (!data || !data.data) throw new Error("No data returned");

    const video = data.data;
    const title = video.title || "Untitled";

    output.innerHTML = `
      <h2 class="video-header">By ${video.author.nickname}</h2>
      <video class="video-player" src="${video.play}" controls autoplay loop=false></video>
      <div class="video-result">
        <div class="download-buttons">
          <select id="downloadOption">
            <option value="${video.play}" selected>No Watermark</option>
            <option value="${video.wmplay}">With Watermark</option>
            <option value="${video.music}">Audio Only</option>
          </select>
          <button onclick="downloadTikTok()">Download</button>
          <button onclick="location.reload()">Get it with another video URL</button>
        </div>
        <div class="data-container">
          <div class="video-title">${title}</div>
          <p><strong>ID:</strong> ${video.id}</p>
          <p><strong>Region:</strong> ${video.region}</p>
          <p><strong>Duration:</strong> ${video.duration} seconds</p>
          <p><strong>Cover:</strong> <a href="${video.cover}" target="_blank">View</a></p>
          <p><strong>AI Dynamic Cover:</strong> <a href="${video.ai_dynamic_cover}" target="_blank">View</a></p>
          <p><strong>Original Cover:</strong> <a href="${video.origin_cover}" target="_blank">View</a></p>
          <p><strong>Play Count:</strong> ${video.play_count}</p>
          <p><strong>Likes:</strong> ${video.digg_count}</p>
          <p><strong>Comments:</strong> ${video.comment_count}</p>
          <p><strong>Shares:</strong> ${video.share_count}</p>
          <p><strong>Downloads:</strong> ${video.download_count}</p>
          <p><strong>Collects:</strong> ${video.collect_count}</p>
          <p><strong>Create Time:</strong> ${new Date(video.create_time * 1000).toLocaleString()}</p>
          <p><strong>Music Title:</strong> ${video.music_info.title}</p>
          <p><strong>Music Author:</strong> ${video.music_info.author}</p>
          <p><strong>Music URL:</strong> <a href="${video.music_info.play}" target="_blank">Listen</a></p>
          <p><strong>Author ID:</strong> ${video.author.id}</p>
          <p><strong>Author Username:</strong> ${video.author.unique_id}</p>
          <p><strong>Author Avatar:</strong> <a href="${video.author.avatar}" target="_blank">View</a></p>
        </div>
      </div>
    `;
  } catch (err) {
    output.innerHTML = "❌ Failed to process: " + err.message;
    output.style.display = "block";
  }
}

function downloadTikTok() {
  const select = document.getElementById("downloadOption");
  const url = select.value;
  const a = document.createElement('a');
  a.href = url;
  a.download = '';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}